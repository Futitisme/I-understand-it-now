<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Клиентское приложение</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 0;
            background-color: #f4f4f9;
            color: #333;
        }

        h1 {
            text-align: center;
            margin: 20px 0;
        }

        /* Основной контейнер формы */
        form {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        /* Группировка меток и полей ввода */
        .form-group {
            display: flex;
            align-items: center; /* Центрирование по вертикали */
            margin-bottom: 15px;
        }

        label {
            flex: 0 0 150px; /* Фиксированная ширина меток */
            font-weight: bold;
            margin-right: 10px; /* Отступ между меткой и полем */
            white-space: nowrap; /* Запрещает перенос текста метки */
        }

        input[type="text"] {
            flex: 1; /* Поля ввода заполняют оставшееся пространство */
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box; /* Учитывает padding в ширине */
        }

        /* Стиль кнопок */
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }

        button[type="submit"] {
            background-color: #007bff;
            color: white;
            margin-right: 10px;
        }

        button[type="submit"]:hover {
            background-color: #0056b3;
        }

        #controls {
            display: flex;
            justify-content: flex-start; /* Выравнивание кнопок слева */
            max-width: 600px;
            margin: 10px auto;
            gap: 10px; /* Расстояние между кнопками */
        }

        #controls button {
            background-color: #6c757d;
            color: white;
        }

        #controls button:hover {
            background-color: #495057;
        }

        /* Блоки вывода */
        #result, #data-output {
            max-width: 600px;
            margin: 20px auto;
            padding: 20px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }

        #function-select {
            margin-top: 10px; /* Отступ сверху для дропбокса */
        }

        p {
            margin-top: 5px; /* Отступ сверху для текста "или выберите из списка" */
            font-style: italic; /* Изменение стиля текста */
        }

        #plot {
            width: 100%;
            max-width: 800px;
            margin: 20px auto;
            border: 1px solid #ccc;
        }

        #result {
            margin-top: 20px;
        }

        #data-output {
            margin-top: 20px;
            border: 1px solid #ccc;
            padding: 10px;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
<h1>Клиентское приложение</h1>
<form id="calculation-form">
    <label for="function">Функция:</label>
    <input type="text" id="function" name="function" placeholder="Например: 2*sin(x) + cos(x)" required><br>

    <label for="x_start">Начало диапазона:</label>
    <input type="text" id="x_start" name="x_start" placeholder="Например: -2*pi" required><br>

    <label for="x_end">Конец диапазона:</label>
    <input type="text" id="x_end" name="x_end" placeholder="Например: 2*pi" required><br>

    <label for="step">Шаг вычислений:</label>
    <input type="text" id="step" name="step" placeholder="Например: pi/4" required><br>

    <label for="function-select">Или выбрать из списка:</label>
    <select id="function-select">
        <option value="">Выберите фамилию</option>
        <option value="Volosov">Volosov</option>
        <option value="Vasiliev">Vasiliev</option>
        <option value="Suryaninova">Suryaninova</option>
    </select>

    <button type="submit">Построить график</button>
</form>

<div id="plot"></div>

<div id="controls">
    <button id="toggle-pause" style="display: none;">Пауза</button>
    <button id="reset">Сброс</button>
</div>

<div id="result">
    <h2>Результат:</h2>
    <pre id="response-data"></pre>
</div>

<div id="data-output">
    <h2>Полученные данные:</h2>
    <pre id="data-log"></pre>
</div>

<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
    const form = document.getElementById('calculation-form');
    const resultDiv = document.getElementById('response-data');
    const plotDiv = document.getElementById('plot');
    const togglePauseButton = document.getElementById('toggle-pause');
    const resetButton = document.getElementById('reset');
    const dataLog = document.getElementById('data-log');
    const functionSelect = document.getElementById('function-select');

    let interval = null;
    let isPaused = false;
    let xValues = [];
    let yValues = [];
    let currentIndex = 0;

    functionSelect.addEventListener('change', () => {
        const selectedName = functionSelect.value;
        if (selectedName) {
            fetch(`/get_function?name=${selectedName}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Received data:', data);
                    document.getElementById('function').value = data.function;
                    document.getElementById('x_start').value = data.x_start;
                    document.getElementById('x_end').value = data.x_end;
                    document.getElementById('step').value = data.step;
                })
                .catch(error => {
                    console.error('Ошибка при получении данных:', error);
                });
        } else {
            document.getElementById('function').value = '';
            document.getElementById('x_start').value = '';
            document.getElementById('x_end').value = '';
            document.getElementById('step').value = '';
        }
    });

    form.addEventListener('submit', (e) => {
        e.preventDefault();
        resultDiv.textContent = '';  // Очистка предыдущих ошибок и данных
        togglePauseButton.style.display = 'inline-block';

        // Считываем значения формы
        const formData = new FormData(form);
        let func = formData.get('function');
        let xStart = formData.get('x_start');
        let xEnd = formData.get('x_end');
        let step = formData.get('step');

        const replaceConstants = (input) => {
            return input.replace(/\bpi\b/g, Math.PI).replace(/\be\b/g, Math.E);
        };

        try {
            xStart = eval(replaceConstants(xStart));
            xEnd = eval(replaceConstants(xEnd));
            step = eval(replaceConstants(step));

            if (!func) {
                throw new Error("Функция не может быть пустой.");
            }

            func = func.replace(/\b(sin|cos|tan|log|exp|sqrt)\b/g, 'Math.$1');

            if (xStart >= xEnd || step <= 0) {
                resultDiv.textContent = "Ошибка: Проверьте диапазон или шаг.";
                return;
            }

            xValues = [];
            yValues = [];
            for (let x = xStart; x <= xEnd; x += step) {
                const y = eval(func.replace(/x/g, `(${x})`));
                xValues.push(x);
                yValues.push(y);
            }

            const trace = {
                x: xValues,
                y: yValues,
                mode: 'lines+markers',
                name: 'График функции',
                marker: { color: 'blue' }
            };

            const layout = {
                title: 'График функции',
                xaxis: { title: 'X' },
                yaxis: { title: 'Y' },
                hovermode: 'closest'
            };

            Plotly.newPlot(plotDiv, [trace], layout);

            currentIndex = 0;
            isPaused = false;
            drawNextPoint();

        } catch (error) {
            resultDiv.textContent = `Ошибка: ${error.message}`;
        }
    });

    togglePauseButton.addEventListener('click', () => {
        isPaused = !isPaused;
        togglePauseButton.textContent = isPaused ? 'Продолжить' : 'Пауза';

        if (!isPaused) {
            drawNextPoint(); // Запускаем построение графика снова
        }
    });

    resetButton.addEventListener('click', () => {
        clearInterval(interval);
        xValues = [];
        yValues = [];
        currentIndex = 0;
        resultDiv.textContent = '';
        plotDiv.innerHTML = '';
        dataLog.textContent = ''; // Очистка данных
        togglePauseButton.style.display = 'none';
    });

    function drawNextPoint() {
        if (currentIndex < xValues.length && !isPaused) {
            const trace = Plotly.restyle(plotDiv, 'x', [xValues.slice(0, currentIndex + 1)]);
            Plotly.restyle(plotDiv, 'y', [yValues.slice(0, currentIndex + 1)]);
            const now = new Date();
            const timestamp = `${now.toLocaleTimeString()}.${String(now.getMilliseconds()).padStart(3, '0')}`; // Временная метка с миллисекундами
            dataLog.textContent += `Время: ${timestamp}, X: ${xValues[currentIndex]}, Y: ${yValues[currentIndex]}\n`;
            currentIndex++;
            interval = setTimeout(drawNextPoint, 50);
        } else if (currentIndex >= xValues.length) {
            clearInterval(interval);
            resultDiv.textContent = `Успешно построено ${xValues.length} точек.`;
            togglePauseButton.style.display = 'none';
        }
    }
</script>
</body>
</html>
